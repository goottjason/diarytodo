<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/layout.html}">
<head>

  <!-- head fragment: 레이아웃 템플릿에서 head 영역을 대체 -->
  <th:block layout:fragment="head">
    <title>To-Do</title>
  </th:block>

  <!-- style fragment: 페이지 전용 스타일 정의 -->
  <th:block layout:fragment="style">
    <style>

      /* 전체 레이아웃: 좌측(사이드바), 중앙(메인), 우측(디테일) */
      .todo-layout {
        display: flex; /* flex로 좌우 배치 */
        width: 100%;
        min-height: 80vh;
      }
      /* 좌측 사이드바 스타일 */
      .sidebar {
        width: 260px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(44, 62, 80, 0.07);
        border: 1px solid #f2f4f6;
        padding: 0;
        margin-right: 32px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      /* 사이드바 메뉴 리스트 */
      .sidebar-menu {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      /* 사이드바 메뉴 항목 */
      .sidebar-menu-item {
        display: flex;
        align-items: center;
        padding: 13px 18px;
        border-bottom: 1px solid #f6f6f6;
      }
      /* 사이드바 메뉴 링크(아이콘+텍스트) */
      .sidebar-menu-link {
        flex: 1;
        text-decoration: none;
        color: #222;
        font-size: 15px;
        margin-left: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      /* 사이드바 카운트(오른쪽 숫자) */
      .sidebar-count {
        color: #b3b3b3;
        font-size: 15px;
      }
      /* 캘린더 컨테이너 */
      .calendar-container {
        margin: 16px 18px 0 18px;
      }
      /* 메인 콘텐츠 영역(중앙) */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      /* 상단 헤더(메뉴명, 날짜, 정렬) */
      .todo-header {
        padding: 28px 32px 18px 32px;
        border-radius: 6px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        min-height: 72px;
        box-sizing: border-box;
        background: #fff;
        margin-bottom: 16px;
      }
      /* 헤더: 메뉴명 */
      .todo-header-title {
        font-size: 23px;
        font-weight: 700;
        color: #222;
        line-height: 1.4;
      }
      /* 헤더: 날짜 */
      .todo-header-date {
        font-size: 16px;
        color: #888;
        margin-top: 2px;
        padding-left: 50px;
        text-align: left;
      }
      /* 헤더: 정렬 버튼/셀렉트 */
      .todo-header-controls {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      /* 정렬 버튼 스타일 */
      .todo-header-sort-btn {
        background: #b1b1b1;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 2px 10px;
        font-size: 15px;
        cursor: pointer;
        margin-right: 6px;
      }
      /* 정렬 셀렉트박스 */
      .todo-header-select {
        width: 130px;
        font-size: 12px;
        padding: 3px 8px;
        border: 1px solid #b7c1c7;
        border-radius: 5px;
        background: #fff;
        color: #222;
        outline: none;
        cursor: pointer;
      }
      /* 할일 입력 영역 */
      .todo-input-section {
        margin-bottom: 24px;
        background: #fff;
        border-radius: 6px;
        padding: 24px 32px 20px 32px;
        box-shadow: 0 1px 4px rgba(44, 62, 80, 0.07);
      }
      /* 할일 입력 줄 */
      .todo-input-row {
        margin-bottom: 8px;
      }
      /* 할일 입력창 */
      .todo-input {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        outline: none;
      }
      /* 할일 입력 하단(아이콘, 추가버튼) */
      .todo-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
      }
      /* 할일 입력 아이콘들 */
      .todo-actions {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      /* 아이콘 스타일(파란색, 커서) */
      .action-icon {
        color: #1e3050;
        cursor: pointer;
        pointer-events: auto;
        font-size: 18px;
      }
      /* 숨겨진 날짜 입력 */
      .hidden-date-input {
        opacity: 0;
        width: 1px;
        height: 1px;
        position: absolute;
        left: -9999px;
        top: -9999px;
      }
      /* 날짜 힌트(선택시 안내) */
      .date-hint {
        display: none;
        color: #757575;
        margin-left: 8px;
      }
      /* 추가 버튼 */
      .add-btn {
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 24px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
      }
      /* 추가입력(위치, 메모) */
      .extra-inputs {
        display: none;
        margin-top: 12px;
      }
      /* 추가입력 그룹(위치/메모) */
      .extra-input-group {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 6px;
      }
      /* 추가입력 라벨 */
      .extra-input-label {
        min-width: 40px;
        font-size: 15px;
        color: #444;
      }
      /* 추가입력 인풋 */
      .extra-input {
        width: 160px;
        padding: 5px 8px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 15px;
      }
      /* 할일 목록 영역 */
      .todo-list-container {
        margin-top: 16px;
      }
      /* 우측 상세 패널 */
      .detail-panel {
        width: 340px;
        margin-left: 32px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(44, 62, 80, 0.07);
        border: 1px solid #f2f4f6;
        min-height: 400px;
        padding: 18px;
      }
      /* 모달 오버레이(배경) */
      .modal-overlay {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 9999;
      }
      /* 모달 컨텐츠(중앙 박스) */
      .modal-content {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 24px #0002;
        padding: 32px 32px 24px 32px;
        min-width: 340px;
        max-width: 90vw;
        text-align: center;
      }
      /* 모달 행 */
      .modal-row {
        margin-bottom: 18px;
        text-align: left;
      }
      /* 모달 라벨 */
      .modal-row label {
        font-weight: 500;
        margin-right: 16px;
      }
      /* 모달 날짜입력 */
      .modal-date-input {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      /* 모달 안내문 */
      .modal-tip {
        font-size: 14px;
      }
      /* 모달 버튼 영역 */
      .modal-actions {
        margin-top: 28px;
      }
      /* 모달 제출 버튼 */
      .modal-submit-btn {
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 24px;
        font-size: 16px;
        font-weight: 500;
        margin-right: 10px;
        cursor: pointer;
      }
      /* 모달 취소 버튼 */
      .modal-cancel-btn {
        background: #fff;
        color: #1976d2;
        border: 1.5px solid #1976d2;
        border-radius: 6px;
        padding: 8px 24px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
      }
    </style>
  </th:block>
</head>
<body>
<!-- 전체 콘텐츠 fragment -->
<div layout:fragment="content">

  <!-- ■ 전체 레이아웃 ■ -->
  <div class="todo-layout">
    <!-- 좌측: 사이드바 -->
    <aside class="sidebar">
      <ul class="sidebar-menu">
        <!-- 오늘 To-Do 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('onlyTodayList');">
            <i class="fa-solid fa-calendar-plus"></i>
            <span>오늘 To-Do</span>
          </a>
          <span id="count-today" class="sidebar-count"></span>
        </li>
        <!-- 모든 To-Do 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('allList');">
            <i class="fa-solid fa-box"></i>
            <span>모든 To-Do</span>
          </a>
          <span id="count-all" class="sidebar-count"></span>
        </li>
        <!-- 미완료 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('unfinishedList');">
            <i class="fa-regular fa-circle"></i>
            <span>미완료된 To-Do</span>
          </a>
          <span id="count-unfinished" class="sidebar-count"></span>
        </li>
        <!-- 중요 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('starList');">
            <i class="fa-solid fa-star"></i>
            <span>중요한 To-Do</span>
          </a>
          <span id="count-star" class="sidebar-count"></span>
        </li>
        <!-- 기한 있는 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('isNotNullDuedateList');">
            <i class="fa-solid fa-timeline"></i>
            <span>기한이 있는 To-Do</span>
          </a>
          <span id="count-duedate" class="sidebar-count"></span>
        </li>
        <!-- 기한 없는 메뉴 -->
        <li class="sidebar-menu-item">
          <a href="javascript:void(0);" class="sidebar-menu-link" onclick="selectWhere('isNullDuedateList');">
            <i class="fa-solid fa-bars-staggered"></i>
            <span>기한이 없는 To-Do</span>
          </a>
          <span id="count-no-duedate" class="sidebar-count"></span>
        </li>
      </ul>
      <!-- 캘린더 영역 -->
      <div class="calendar-container">
        <div id="calendar"></div>
        <input type="hidden" id="selected-date" readonly>
      </div>
    </aside>

    <!-- 중앙: 메인 콘텐츠 -->
    <main class="main-content">
      <!-- 상단 헤더 -->
      <header class="todo-header">
        <div>
          <div id="header-title" class="todo-header-title"></div>
          <div id="header-date" class="todo-header-date">4월 21일, 월요일</div>
        </div>
        <div class="todo-header-controls">
          <!-- 정렬 버튼 -->
          <button id="sort-btn" class="todo-header-sort-btn">
            <i id="sort-icon" class="fa-solid fa-arrow-up-wide-short"></i>
          </button>
          <!-- 정렬 셀렉트 -->
          <select id="sort-select" class="todo-header-select" name="sort-select">
            <option value="duedate">마감일순</option>
            <option value="dno">등록일순</option>
            <option value="title">제목순</option>
          </select>
        </div>
      </header>

      <!-- 할일 입력 영역 -->
      <section class="todo-input-section">
        <div class="todo-input-row">
          <input id="todo-title-input" class="todo-input" type="text" placeholder="이곳에 할일을 추가해보세요" />
        </div>
        <div class="todo-footer">
          <div class="todo-actions">
            <!-- 마감일 아이콘/입력 -->
            <span>
              <input type="date" id="todo-duedate-input" class="hidden-date-input">
              <label for="todo-duedate-input">
                <i id="duedate-btn" class="fa-solid fa-calendar-days action-icon"></i>
              </label>
            </span>
            <!-- 중요도 아이콘 -->
            <span>
              <i id="star-btn" class="fa-regular fa-star action-icon"></i>
            </span>
            <!-- 추가입력(위치, 메모) 토글 -->
            <span>
              <i id="extra-btn" class="fa-regular fa-circle-down action-icon"></i>
            </span>
            <!-- 날짜 힌트 -->
            <span id="date-hint" class="date-hint"></span>
          </div>
          <!-- 추가 버튼 -->
          <button id="add-todo-btn" class="add-btn" onclick="register();">추가</button>
        </div>
        <!-- 위치/메모 추가입력 -->
        <div id="extra-inputs" class="extra-inputs">
          <div class="extra-input-group">
            <span class="extra-input-label">위치</span>
            <input type="text" id="todo-location-input" class="extra-input">
          </div>
          <div class="extra-input-group">
            <span class="extra-input-label">메모</span>
            <input type="text" id="todo-memo-input" class="extra-input">
          </div>
        </div>
      </section>

      <!-- 할일 목록 영역 -->
      <section class="todo-list-container">
        <div id="todo-list-area"></div>
      </section>
    </main>

    <!-- 우측: 상세 패널 -->
    <aside class="detail-panel">
      <div id="todo-detail"></div>
    </aside>
  </div>

  <!-- 수정 모달 -->
  <div id="modal-edit-overlay" class="modal-overlay">
    <div id="modal-edit" class="modal-content">
      <h3>선택한 할일 일괄 수정</h3>
      <form id="form-edit-multi">
        <div class="modal-row">
          <label>완료 상태</label>
          <label><input type="radio" name="finished" value="1"> 완료로 변경</label>
          <label><input type="radio" name="finished" value="0"> 미완료로 변경</label>
          <label><input type="radio" name="finished" value="9" checked> 그대로 두기</label>
        </div>
        <div class="modal-row">
          <label>중요도</label>
          <label><input type="radio" name="star" value="1"> 중요로 변경</label>
          <label><input type="radio" name="star" value="0"> 중요 해제</label>
          <label><input type="radio" name="star" value="9" checked> 그대로 두기</label>
        </div>
        <div class="modal-row">
          <label>마감일</label>
          <input type="date" name="duedate" class="modal-date-input">
          <span class="modal-tip"><br>그대로 두려면 날짜를 선택하지 마세요</span>
        </div>
        <div class="modal-actions">
          <button type="submit" class="modal-submit-btn">수정</button>
          <button type="button" id="modal-edit-cancel" class="modal-cancel-btn">취소</button>
        </div>
      </form>
    </div>
  </div>
  <!-- 삭제 모달 -->
  <div id="modal-delete-overlay" class="modal-overlay">
    <div id="modal-delete" class="modal-content">
      <h3>선택 항목 일괄 삭제</h3>
      <form id="form-delete-multi">
        <div class="modal-row">
          <label>정말로 삭제하시겠습니까?</label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="modal-submit-btn">삭제</button>
          <button type="button" id="modal-delete-cancel" class="modal-cancel-btn">취소</button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- 스크립트 fragment: 기능별 JS 코드 -->
<th:block layout:fragment="script">
  <script>
    // ---------------------- 문서 준비 및 이벤트 바인딩 ----------------------
    $(function() {
      // 페이지 로드시 리스트/카운트 초기화
      initialList();
      countTodo();

      // 오늘 날짜 표시
      let today = new Date().toLocaleDateString().substring(0, 10);
      let todayText = new Date().toLocaleDateString();
      $("#header-date").html(todayText);

      // 캘린더 생성 및 날짜 클릭 이벤트
      let specialDates = [];
      let myCalendar = jsCalendar.new("#calendar");
      myCalendar.onDateClick(function(event, date){
        var value = date.toLocaleDateString('sv-SE');
        document.getElementById("selected-date").value = value;
        sessionStorage.setItem("status", "calendarList");
        sessionStorage.setItem("calPickDate", value);
        doList();
      });

      // 캘린더: 특수 날짜 강조 함수
      function calBoldFunc() {
        myCalendar.onDateRender(function(date, element, info) {
          let yyyy = date.getFullYear();
          let mm = String(date.getMonth() + 1).padStart(2, '0');
          let dd = String(date.getDate()).padStart(2, '0');
          let value = yyyy + '-' + mm + '-' + dd;
          if(specialDates.includes(value)){
            element.style.fontWeight = 'bold';
            element.style.color = '#0f1d41';
            element.style.fontSize = '16px';
          }
        });
      }
      // 캘린더 리프레시
      function refreshCalStatus() {
        specialDates = listDuedate();
        calBoldFunc();
        myCalendar.refresh();
      }
      refreshCalStatus();

      // 데이트피커(마감일 입력)
      let picker = new easepick.create({
        element: "#todo-duedate-input",
        css: ["https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.css"],
        zIndex: 10,
        setup(picker) {
          picker.on('select', (e) => {
            let selectedDate = picker.getDate().format('YYYY-MM-DD');
            $('#date-hint').html(`${selectedDate}에 할일이 추가됩니다`).show();
          });
        },
      });

      // 정렬 버튼 클릭 이벤트
      $("#sort-btn").on("click", function() {
        let icon = $("#sort-icon");
        let isAsc = icon.hasClass("fa-arrow-up-wide-short");
        icon.toggleClass("fa-arrow-up-wide-short fa-arrow-down-wide-short");
        sessionStorage.setItem("ordermethod", isAsc ? "desc" : "asc");
        doList();
      });
      // 정렬 셀렉트 변경 이벤트
      $("#sort-select").on("change", function() {
        sessionStorage.setItem("orderby", $(this).val());
        doList();
      });

      // 할일 입력창: 엔터로 추가
      $('#todo-title-input').on('keydown', function(e) {
        if (e.key == "Enter") register();
      });
      // 마감일 아이콘 클릭시 데이트피커 포커스
      $("#duedate-btn").on("click", function() {
        $("#todo-duedate-input").focus();
      });
      // 중요도 아이콘 클릭시 토글
      $("#star-btn").on("click", function() {
        $(this).toggleClass("fa-solid fa-regular");
      });
      // 추가입력 토글
      $("#extra-btn").on("click", function() {
        $("#extra-inputs").toggle();
      });

      // 테이블 체크박스 전체선택/개별선택
      $(document).on('change','#select-all-checkbox', function() {
        $('.row-checkbox').prop('checked', this.checked);
      });
      $(document).on('change', '.row-checkbox', function() {
        if (!this.checked) {
          $('#select-all-checkbox').prop('checked', false);
        } else {
          var allChecked = $('.row-checkbox').length === $('.row-checkbox:checked').length;
          $('#select-all-checkbox').prop('checked', allChecked);
        }
      });

      // 완료 체크박스 클릭시 상태 변경
      $(document).on("click", ".finished-icon", function() {
        let dno = $(this).data("dno");
        let solid = $(this).hasClass("fa-circle-check");
        let checked = !solid;
        let finished = checked ? 1 : 0;
        let data = { "dno": dno, "finished": finished };
        let result = ajaxFunc("/todolist/updateFinished", data, "text");
        if (result == "success") {
          $("#finished-icon-" + dno).toggleClass("fa-circle fa-circle-check");
          $("#title-cell-" + dno).toggleClass("completed", checked);
          doList();
          countTodo();
        }
      });

      // 제목 셀 클릭시 인라인 수정
      $(document).on('click', '.title-cell', function() {
        let span  = $(this).children('.title-span');
        let input = span.siblings('.edit-title-input');
        input.val(span.text()).show().focus();
        span.hide();
      });
      // 제목 수정 엔터/포커스아웃
      $(document).on('keydown', '.edit-title-input', function(e) {
        if (e.key === "Enter") {
          let dno = $(this).data("dno");
          let value = $(this).val();
          let span = $(this).siblings('.title-span');
          span.text(value).show();
          $(this).hide();
          titleModify(dno, value);
          countTodo();
        }
      });
      $(document).on('blur', '.edit-title-input', function() {
        let dno = $(this).data("dno");
        let value = $(this).val();
        let span = $(this).siblings('.title-span');
        span.text(value).show();
        $(this).hide();
        titleModify(dno, value);
        countTodo();
      });

      // 마감일 셀 클릭시 인라인 수정
      $(document).on('click', '.duedate-cell', function() {
        let span  = $(this).children('.duedate-span');
        let input = span.siblings('.edit-duedate-input');
        input.val(span.text()).show().focus();
        span.hide();
      });
      // 마감일 수정 엔터/포커스아웃
      $(document).on('keydown', '.edit-duedate-input', function(e) {
        if (e.key === "Enter") {
          let dno = $(this).data("dno");
          let value = $(this).val();
          let span = $(this).siblings('.duedate-span');
          span.text(value).show();
          $(this).hide();
          duedateModify(dno, value);
          countTodo();
          refreshCalStatus();
        }
      });
      $(document).on('blur', '.edit-duedate-input', function() {
        let dno = $(this).data("dno");
        let value = $(this).val();
        let span = $(this).siblings('.duedate-span');
        span.text(value).show();
        $(this).hide();
        duedateModify(dno, value);
        countTodo();
        refreshCalStatus();
      });

      // 중요도 아이콘 클릭시 상태 변경
      $(document).on("click", ".star-icon", function() {
        let dno = $(this).data("dno");
        let solid = $(this).hasClass("fa-solid");
        let star = solid ? 0 : 1;
        let data = { "dno": dno, "star": star };
        let result = ajaxFunc("/todolist/updateStar", data, "text");
        if (result == "success") {
          $("#star-icon-" + dno).toggleClass("fa-solid");
          doList();
          countTodo();
        }
      });

      // 상세 보기 버튼 클릭시
      $(document).on("click", ".more-btn", function() {
        let dno = $(this).data("dno");
        let data = {"dno": dno};
        let result = ajaxFunc("/todolist/selectone", data, null);
        let html = jQuery('<div>').html(result);
        let contents = html.find("div#ajaxTodoDetail").html();
        $("#todo-detail").html(contents);
      });

      // 삭제 버튼 클릭시
      $(document).on("click", ".delete-btn", function() {
        let dno = $(this).data("dno");
        let data = { "dno": dno };
        let result = ajaxFunc("/todolist/deleteTodo", data, "text");
        $("#todo-detail").html("");
        doList();
        countTodo();
      });

      // 선택수정 모달 열기/닫기
      $(document).on('click','#multi-edit-btn', function() {
        $('#modal-edit-overlay').fadeIn(150);
      });
      $(document).on('click','#modal-edit-cancel, #modal-edit-overlay', function(e) {
        if (e.target.id === 'modal-edit-overlay' || e.target.id === 'modal-edit-cancel') {
          $('#modal-edit-overlay').fadeOut(150);
        }
      });
      $(document).on('click','#modal-edit', function(e) {
        e.stopPropagation();
      });
      // 선택수정 폼 제출
      $(document).on('submit','#form-edit-multi', function(e) {
        e.preventDefault();
        let finished = $('input[name="finished"]:checked').val() ?? '';
        let star = $('input[name="star"]:checked').val() ?? '';
        let duedate = $('input[name="duedate"]').val() ?? '';
        let selectedArr = $('.row-checkbox:checked').map(function(){ return $(this).data('dno'); }).get();
        updateSelectedAll(selectedArr, finished, star, duedate);
        $('#modal-edit-overlay').fadeOut(150);
      });

      // 선택삭제 모달 열기/닫기
      $(document).on('click','#multi-delete-btn', function() {
        $('#modal-delete-overlay').fadeIn(150);
      });
      $(document).on('click','#modal-delete-cancel, #modal-delete-overlay', function(e) {
        if (e.target.id === 'modal-delete-overlay' || e.target.id === 'modal-delete-cancel') {
          $('#modal-delete-overlay').fadeOut(150);
        }
      });
      $(document).on('click','#modal-delete', function(e) {
        e.stopPropagation();
      });
      // 선택삭제 폼 제출
      $(document).on('submit','#form-delete-multi', function(e) {
        e.preventDefault();
        let selectedArr = $('.row-checkbox:checked').map(function(){ return $(this).data('dno'); }).get();
        deleteSelectedAll(selectedArr);
        $('#modal-delete-overlay').fadeOut(150);
      });

      // 상세 패널 내 수정/삭제 버튼
      $(document).on("click", ".detail-edit-btn", function() {
        let dno      = $(this).data("dno");
        let title    = $("#detail-title-" + dno).val();
        let duedate  = $("#detail-duedate-" + dno).val();
        let memo     = $("#detail-memo-" + dno).val();
        let location = $("#detail-location-" + dno).val();
        let data = {
          dno: dno, title: title,
          duedate: duedate, memo: memo, location: location
        };
        let result = ajaxFunc("/todolist/updateDetail", data, "text");
        let nowUpdateTime = new Date().toLocaleString();
        $("#now-update-time").html(nowUpdateTime);
        $("#update-time-view").show();
        doList();
        countTodo();
        refreshCalStatus();
      });
      $(document).on("click", ".detail-delete-btn", function() {
        let dno      = $(this).data("dno");
        let data = { dno: dno };
        let result = ajaxFunc("/todolist/deleteDetail", data, "text");
        let nowUpdateTime = new Date().toLocaleString();
        $("#now-update-time").html(nowUpdateTime);
        $("#update-time-view").show();
        $("#todo-detail").html("");
        doList();
        countTodo();
        refreshCalStatus();
      });
    });

    // ---------------------- 주요 함수 정의 ----------------------
    // 리스트/정렬 초기화
    function initialList() {
      sessionStorage.setItem("ordermethod", "asc"); // 정렬방식 오름차순
      sessionStorage.setItem("orderby", "duedate"); // 정렬기준 마감일순
      sessionStorage.setItem("status", "allList"); // 모든 리스트 가져오기
      doList();
    }
    // 카운트(사이드바 숫자) 갱신
    function countTodo() {
      let today = new Date().toISOString().substring(0, 10);
      let data = { today : today }
      let result = ajaxFunc("/todolist/todoCnt", data, "text");
      let info = jQuery('<div>').html(result);
      $("#count-today").html(info.find("#spanTodayCnt").html());
      $("#count-all").html(info.find("#spanAllCnt").html());
      $("#count-unfinished").html(info.find("#spanUnfinishedCnt").html());
      $("#count-star").html(info.find("#spanStarCnt").html());
      $("#count-duedate").html(info.find("#spanIsDuedateCnt").html());
      $("#count-no-duedate").html(info.find("#spanIsNotDuedateCnt").html());
    }
    // 마감일 있는 날짜 리스트
    function listDuedate() {
      let result = ajaxFunc("/todolist/listDuedate", null, "text");
      let info = jQuery('<div>').html(result);
      spans = info.find(".duedateByTodo");
      let tempList = new Array();
      spans.each(function() {
        tempList.push($(this).html());
      });
      return tempList;
    }
    // 메뉴 클릭시 상태 변경
    function selectWhere(status) {
      sessionStorage.setItem("status", status);
      doList();
    }
    // 검색
    function doSearch(searchTypes, searchWord) {
      let orderby = sessionStorage.getItem("orderby");
      let ordermethod = sessionStorage.getItem("ordermethod");
      let data = {
        searchTypes: searchTypes,
        searchWord: searchWord,
        orderby: orderby,
        ordermethod: ordermethod
      };
      let result = ajaxFunc("/todolist/selectMulti", data, null);
      let html = jQuery('<div>').html(result);
      let contents = html.find("div#ajaxList").html();
      $("#todo-list").html(contents);
    }
    // 할일 등록
    function register() {
      let title = $("#todo-title-input").val();
      let duedate = $("#todo-duedate-input").val();
      let star = $("#star-btn").hasClass("fa-solid") ? 1 : 0;
      let location = $("#todo-location-input").val();
      let memo = $("#todo-memo-input").val();
      let data = JSON.stringify({
        title: title,
        duedate: duedate,
        star:star,
        location:location,
        memo:memo
      });
      let result = ajaxFunc2('/todolist/insertTodo', 'application/json', 'text', data);
      if (result == "success") {
        $("#todo-title-input").val("");
        doList();
        countTodo();
      }
    }
    // 제목 수정
    function titleModify(dno, modValue) {
      let title = modValue;
      let data = { "dno": dno, "title": title };
      let result = ajaxFunc("/todolist/updateTitle", data, "text");
      if (result == "success") {
        doList();
      }
    }
    // 마감일 수정
    function duedateModify(dno, modValue) {
      let duedate = modValue;
      let data = { "dno": dno, "duedate": duedate };
      let result = ajaxFunc("/todolist/updateDuedate", data, "text");
      if (result == "success") {
        doList();
      }
    }
    // 선택 수정
    function updateSelectedAll(selectedArr, finished, star, duedate) {
      let data = JSON.stringify({
        selectedArr: selectedArr,
        finished: finished,
        star: star,
        duedate: duedate
      });
      let result = ajaxFunc2('/todolist/updateSelectedAll', 'application/json', 'text', data);
      if (result == "success") {
        doList();
        countTodo();
      } else {
        alert("적어도 하나는 선택해야 수정이 된단다.");
      }
    }
    // 선택 삭제
    function deleteSelectedAll(selectedArr) {
      let data = JSON.stringify({
        selectedArr: selectedArr,
      });
      let result = ajaxFunc2('/todolist/deleteSelectedAll', 'application/json', 'text', data);
      if (result == "success") {
        doList();
        countTodo();
      } else {
        alert("삭제할 항목이 없습니다. 선택해주세요.");
      }
    }

    function doList() {

      let ordermethod = sessionStorage.getItem("ordermethod");
      let orderby = sessionStorage.getItem("orderby");
      let status = sessionStorage.getItem("status");

      /*let duedate = null;
      if (status == "onlyTodayList") { // 오늘할일 가져오려면 duedate를 오늘로 설정
        duedate = new Date().toISOString().substring(0, 10);
      } else if (status == "calendarList") { // 캘린더에서 픽한 할일 가져오려면 calpickDate로...
        duedate = sessionStorage.getItem("calPickDate");
      }

      let data = null;
      if (status == "onlyTodayList" || status == "calendarList") {
        duedate =
          data = {
            duedate : duedate,
            star : 'all',
            finished : 'all',
            ordermethod : ordermethod,
            orderby : orderby
          }
        $("#menuTitleArea").html($("#onlyTodayText").html());
      } else if (status == "allList") {
        data = {
          ordermethod : ordermethod,
          orderby : orderby
        }
        $("#menuTitleArea").html($("#allText").html());
      } else if (status == "unfinishedList") {
        data = {
          duedate : 'all',
          star : 'all',
          finished : 'unchecked',
          ordermethod : ordermethod,
          orderby : orderby
        }
        $("#menuTitleArea").html($("#unfinishedText").html());
      } else if (status == "starList") {
        data = {
          duedate : 'all',
          star : 'checked',
          finished : 'all',
          ordermethod : ordermethod,
          orderby : orderby
        }
        $("#menuTitleArea").html($("#starText").html());
      } else if (status == "isNotNullDuedateList") {
        data = {
          duedate : 'isnotnull',
          star : 'all',
          finished : 'all',
          ordermethod : ordermethod,
          orderby : orderby
        }
        $("#menuTitleArea").html($("#isNotNullDuedateText").html());
      } else if (status == "isNullDuedateList") {
        data = {
          duedate : 'isnull',
          star : 'all',
          finished : 'all',
          ordermethod : ordermethod,
          orderby : orderby
        }
        $("#menuTitleArea").html($("#isNullDuedateText").html());
      } else if (status == "searchList") {
        $("#menuTitleArea").html($("#searchText").html());
      }*/


      data = JSON.stringify({
        sortBy : "duedate",
        sortDirection: "ASC",
        writer: "goottjason"
      })
      callAjaxHtml('todo/getTodos', 'POST', data, function(html) {
        $('#todo-list-area').html(html);
      });

      let result = ajaxFunc("/todo/getTodos", data, null);
      let html = jQuery('<div>').html(result);
      let contents = html.find("div#ajaxList").html();
      $("#todolist").html(contents);
    }

    function callAjaxHtml(url, type, data, callback) {
      $.ajax({
        url: url,
        type: type,
        data: data,
        contentType: 'application/json', /*'application/x-www-form-urlencoded'*/
        dataType: 'html', // 서버에서 HTML fragment를 응답받을 때
        success: function(response) {
          callback(response); // 결과값을 콜백에 전달
        },
        error: function(xhr, status, error) {
          // 필요시 에러 콜백도 추가 가능
          alert('목록을 불러오지 못했습니다.');
        }
      });
    }

    function ajaxFunc(url, data, dataType=null) {
      let result = "";
      $.ajax({
        url : url,
        type : "POST",
        data : data,
        dataType : dataType,
        async : false,
        success : function(data) {
          result = data;
        },
        error : function() {
        },
        complete : function() {
        },
      });
      return result;
    }

    function ajaxFunc2(url, contentType, dataType, data) {
      let result = "";
      $.ajax({
        url : url,
        type : "POST",
        contentType: contentType, // 클라이언트가 서버로 보내는 데이터타입
        dataType : dataType, // 서버로부터 받을 응답 데이터의 타입
        data : data,
        async : false,
        success : function(data) {
          result = data;
        },
        error : function() {
        },
        complete : function() {
        },
      });
      return result;
    }
  </script>
</th:block>
</body>
</html>